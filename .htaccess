# Deny access to database directory
<Files ~ "\.sqlite$">
Order allow,deny
Deny from all
</Files>

# Deny access to the schema.sql file
<Files ~ "schema\.sql$">
Order allow,deny
Deny from all
</Files>

# Protect Invoice Email API configuration and logs
<Files "config.php">
Order allow,deny
Deny from all
</Files>

<Files ~ "\.log$">
Order allow,deny
Deny from all
</Files>

<Files "rate_limits.json">
Order allow,deny
Deny from all
</Files>

# Protect database directory
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule ^database/ - [F,L]
</IfModule>

# Prevent directory listing
Options -Indexes

# Set default character set
AddDefaultCharset UTF-8

# Protect against XSS attacks and set security policy
<IfModule mod_headers.c>
    Header set X-XSS-Protection "1; mode=block"
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' \
            https://cdnjs.cloudflare.com \
            https://s3-us-west-2.amazonaws.com \
            https://www.paypal.com \
            https://*.paypal.com \
            https://www.sandbox.paypal.com \
            https://*.paypalobjects.com \
            https://js.stripe.com \
            https://*.stripe.com \
            https://sandbox.web.squarecdn.com \
            https://web.squarecdn.com \
            https://*.squarecdn.com \
            https://*.squareup.com \
            https://www.googletagmanager.com \
            https://*.googletagmanager.com \
            https://www.google-analytics.com \
            https://*.google-analytics.com \
            https://googleads.g.doubleclick.net \
            https://*.doubleclick.net; \
        style-src 'self' 'unsafe-inline' \
            https://fonts.googleapis.com \
            https://cdnjs.cloudflare.com \
            https://*.paypalobjects.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.squareup.com; \
        font-src 'self' \
            https://fonts.gstatic.com \
            https://cdnjs.cloudflare.com \
            https://*.paypalobjects.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.cloudfront.net; \
        img-src 'self' data: \
            https://s3-us-west-2.amazonaws.com \
            https://chart.googleapis.com \
            https://*.paypalobjects.com \
            https://*.paypal.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.squareup.com \
            https://www.google-analytics.com \
            https://*.google-analytics.com \
            https://googleads.g.doubleclick.net \
            https://*.doubleclick.net; \
        frame-src \
            https://www.youtube.com \
            https://www.youtube-nocookie.com \
            https://www.paypal.com \
            https://*.paypal.com \
            https://www.sandbox.paypal.com \
            https://*.sandbox.paypal.com \
            https://js.stripe.com \
            https://*.stripe.com \
            https://*.squarecdn.com \
            https://*.squareup.com \
            https://td.doubleclick.net \
            https://*.doubleclick.net \
            https://www.googletagmanager.com \
            https://*.googletagmanager.com; \
        connect-src 'self' \
            https://formspree.io \
            https://www.paypal.com \
            https://*.paypal.com \
            https://www.sandbox.paypal.com \
            https://*.sandbox.paypal.com \
            https://*.paypalobjects.com \
            https://api.stripe.com \
            https://*.stripe.com \
            https://checkout.stripe.com \
            https://connect.squareup.com \
            https://*.squareup.com \
            https://api.squareup.com \
            https://*.squarecdn.com \
            https://sandbox.web.squarecdn.com \
            https://web.squarecdn.com \
            https://pci-connect.squareupsandbox.com \
            https://pci-connect.squareup.com \
            https://*.squareupsandbox.com \
            https://www.google-analytics.com \
            https://*.google-analytics.com \
            https://analytics.google.com \
            https://googleads.g.doubleclick.net \
            https://*.doubleclick.net \
            https://stats.g.doubleclick.net \
            https://www.googletagmanager.com \
            https://*.googletagmanager.com \
            https://www.google.com \
            https://googleleads.g.doubleclick.net \
            https://td.doubleclick.net \
            https://www.google.com/ccm/collect \
            https://www.google.com/pagead/1p-conversion \
            https://www.google.com/pagead/viewthroughconversion \
            https://googleleads.g.doubleclick.net/pagead/viewthroughconversion \
            https://www.google.com/pagead/1p-conversion;"
    
    # Add Cache Control for better performance
    <FilesMatch "\.(html|htm|js|css)$">
        Header set Cache-Control "max-age=3600, must-revalidate"
    </FilesMatch>
    
    <FilesMatch "\.(ico|pdf|jpg|jpeg|png|gif|svg)$">
        Header set Cache-Control "max-age=86400, public"
    </FilesMatch>
    
    # Force download for executable files
    <FilesMatch "\.(exe|msi)$">
        Header set Content-Type "application/octet-stream"
        Header set Content-Disposition "attachment"
    </FilesMatch>

    # Force download for cross-platform installer files
    <FilesMatch "\.(AppImage|dmg|pkg)$">
        Header set Content-Type "application/octet-stream"
        Header set Content-Disposition "attachment"
    </FilesMatch>
</IfModule>

# Redirect to error pages
ErrorDocument 400 /error-pages/400.html
ErrorDocument 401 /error-pages/401.html
ErrorDocument 403 /error-pages/403.html
ErrorDocument 404 /error-pages/404.html
ErrorDocument 500 /error-pages/500.html
ErrorDocument 503 /error-pages/503.html

# PHP error handling
php_flag display_errors Off
php_flag log_errors On
php_value error_log error_log.txt

# Rewrite rules
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Protect database directory
    RewriteRule ^database/ - [F,L]
    
    # --- Customer Payment Portal routes ---

    # Invoice view: /invoice/{48-char-hex-token}
    RewriteRule ^invoice/([a-fA-F0-9]{48})/?$ portal/invoice.php?token=$1 [L,QSA]

    # Customer portal: /portal/{48-char-hex-token}
    RewriteRule ^portal/([a-fA-F0-9]{48})/?$ portal/index.php?token=$1 [L,QSA]

    # Provider OAuth callback: /api/portal/connect/callback/{provider}
    RewriteRule ^api/portal/connect/callback/(stripe|paypal|square)/?$ api/portal/connect-callback.php?provider=$1 [L,QSA]

    # Provider connect/disconnect: /api/portal/connect/{provider}
    RewriteRule ^api/portal/connect/(stripe|paypal|square)/?$ api/portal/connect.php?provider=$1 [L,QSA]

    # --- Avalonia (cross-platform) download routes ---

    # Versioned: /download/avalonia/2.1.0/win
    RewriteRule ^download/avalonia/([0-9]+\.[0-9]+\.[0-9]+)/(win|mac|linux)/?$ get_avalonia_installer.php?version=$1&platform=$2 [L,QSA]

    # Latest: /download/avalonia/win
    RewriteRule ^download/avalonia/(win|mac|linux)/?$ get_avalonia_installer.php?platform=$1 [L,QSA]
</IfModule>